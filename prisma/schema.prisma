// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  Admin
  FleetManager
  Supervisor
  Driver
  Viewer
}

enum VehicleStatus {
  InService
  InRepair
  OutOfService
  Surplus
  Decommissioned
}

enum DriverStatus {
  Active
  Inactive
  Suspended
}

enum IncidentSeverity {
  Low
  Medium
  High
  Critical
}

enum IncidentStatus {
  Open
  Closed
}

enum SurplusCondition {
  Good
  Fair
  Poor
  Salvage
}

enum SurplusStatus {
  Requested
  Approved
  Auction
  Recycled
  Closed
}

model User {
  id                        String            @id @default(uuid())
  name                      String
  email                     String            @unique
  passwordHash              String?
  role                      UserRole          @default(Viewer)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  surplusRequestsCreated    SurplusRequest[]  @relation("RequestedBy")
  surplusRequestsApproved   SurplusRequest[]  @relation("ApprovedBy")
  auditLogs                 AuditLog[]
}

model Vehicle {
  id                    String            @id @default(uuid())
  vehicleId             String            @unique
  vin                   String            @unique
  year                  Int
  make                  String
  model                 String
  department            String
  division              String?
  status                VehicleStatus     @default(InService)
  odometer              Int?
  fuelType              String?
  inServiceDate         DateTime?
  replacementTargetYear Int?
  lastDOTDate           DateTime?
  notes                 String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  incidents             Incident[]
  surplusRequests       SurplusRequest[]
}

model Driver {
  id            String        @id @default(uuid())
  driverId      String        @unique
  firstName     String
  lastName      String
  email         String        @unique
  phone         String?
  department    String
  cdlNumber     String?
  cdlExpiration DateTime?
  status        DriverStatus  @default(Active)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  incidents     Incident[]
}

model Incident {
  id           String            @id @default(uuid())
  incidentDate DateTime
  description  String
  severity     IncidentSeverity
  atFault      Boolean           @default(false)
  department   String
  status       IncidentStatus    @default(Open)
  vehicleId    String
  vehicle      Vehicle           @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driverId     String?
  driver       Driver?           @relation(fields: [driverId], references: [id], onDelete: SetNull)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model SurplusRequest {
  id          String           @id @default(uuid())
  vehicleId   String
  vehicle     Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  requestedBy String
  requester   User             @relation("RequestedBy", fields: [requestedBy], references: [id])
  condition   SurplusCondition
  reason      String
  status      SurplusStatus    @default(Requested)
  notes       String?
  approvedBy  String?
  approver    User?            @relation("ApprovedBy", fields: [approvedBy], references: [id])
  approvedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model AuditLog {
  id         String   @id @default(uuid())
  entityType String
  entityId   String
  action     String
  changes    Json?
  actorId    String
  actor      User     @relation(fields: [actorId], references: [id])
  createdAt  DateTime @default(now())
}
